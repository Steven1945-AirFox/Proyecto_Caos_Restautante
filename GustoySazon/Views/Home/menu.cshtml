@model GustoySazon.Models.MesaViewModel

@{
    Layout = null;
}


@{
    ViewBag.Title = "Menú";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Menú</title>
    <link href="~/Content/ClienteMenu.css" rel="stylesheet" />
</head>
<body>
    @using (Html.BeginForm("Menu", "Home", FormMethod.Post, new { id = "pedidoForm", @class = "order-form" }))
    {
        @Html.AntiForgeryToken()

        <div class="menu-header">
            <h1 class="menu-title">Menú de Platillos</h1>
        </div>

        <div class="filters">
            <label>Filtrar por tipo:</label>
            <select id="filterTipo" onchange="filtrarMenu()">
                <option value="todos">Todos</option>
                @foreach (var tipo in Model.Menu.Select(m => m.Tipo).Distinct())
                {
                    <option value="@tipo">@tipo</option>
                }
            </select>

            <label style="margin-left: 20px;">Filtrar por precio:</label>
            <select id="filterPrecio" onchange="filtrarMenu()">
                <option value="todos">Todos</option>
                <option value="menor">Menor a ₡5,000</option>
                <option value="mayor">Mayor o igual a ₡5,000</option>
            </select>
        </div>

        <div class="menu-container">
            @foreach (var item in Model.Menu)
            {
                <div class="menu-item" data-id="@item.Id" data-name="@item.NombreComida" data-price="@item.Precio" data-tipo="@item.Tipo">
                    <img src="@item.ImagenUrl" alt="@item.NombreComida" class="item-image" />
                    <h3 class="item-name">@item.NombreComida</h3>
                    <p class="item-price">₡@item.Precio.ToString("N0")</p>
                    <div class="quantity-control">
                        <button type="button" class="quantity-btn">-</button>
                        <input type="text" class="quantity-input" value="0" readonly />
                        <button type="button" class="quantity-btn">+</button>
                    </div>
                </div>

            }
        </div>

        <div class="order-summary" id="orderSummary">
            <h3 class="summary-title">Resumen de tu Pedido</h3>
            <div id="summaryItems">
                <div class="empty-message">No hay productos seleccionados</div>
            </div>
            <div class="summary-total">
                <span>Total:</span>
                <span id="totalAmount">₡0</span>
            </div>
        </div>

        <div id="hiddenInputs"></div>

        <div class="order-actions">
            <button type="button" class="action-btn cancel-btn" onclick="location.href='@Url.Action("Mesa", "Home")'">Cancelar Orden</button>
            <button type="submit" class="action-btn confirm-btn">Confirmar Pedido</button>
        </div>
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const input = this.parentElement.querySelector('.quantity-input');
                    let value = parseInt(input.value);
                    value = (this.textContent === '+') ? value + 1 : Math.max(0, value - 1);
                    input.value = value;
                    updateOrderSummary();
                });
            });

            document.getElementById('filterTipo').addEventListener('change', filtrarMenu);
            document.getElementById('filterPrecio').addEventListener('change', filtrarMenu);


            document.getElementById('pedidoForm').addEventListener('submit', function (e) {
                updateOrderSummary();
            });
        });





        function updateOrderSummary() {
            const summaryItems = document.getElementById('summaryItems');
            const hiddenInputs = document.getElementById('hiddenInputs');
            let total = 0;
            let hasItems = false;

            summaryItems.innerHTML = '';
            hiddenInputs.innerHTML = '';

            let itemIndex = 0;

            document.querySelectorAll('.menu-item').forEach(item => {
                const cantidad = parseInt(item.querySelector('.quantity-input').value);
                if (cantidad > 0) {
                    hasItems = true;
                    const id = item.getAttribute('data-id');
                    const nombre = item.getAttribute('data-name');
                    const precio = parseFloat(item.getAttribute('data-price'));
                    const precioTotal = precio * cantidad;
                    total += precioTotal;

                    // Mostrar resumen de la orden
                    const resumen = document.createElement('div');
                    resumen.className = 'summary-item';
                    resumen.innerHTML = `<span>${nombre} x ${cantidad}</span><span>₡${precioTotal.toLocaleString()}</span>`;
                    summaryItems.appendChild(resumen);

                    hiddenInputs.innerHTML += `
                        <input type="hidden" name="Pedidos[${itemIndex}].MenuId" value="${id}" />
                        <input type="hidden" name="Pedidos[${itemIndex}].NombreComida" value="${nombre}" />
                        <input type="hidden" name="Pedidos[${itemIndex}].Cantidad" value="${cantidad}" />
                        <input type="hidden" name="Pedidos[${itemIndex}].PrecioUnitario" value="${precio}" />
                        <input type="hidden" name="Pedidos[${itemIndex}].PrecioTotal" value="${precioTotal}" />
                    `;

                            itemIndex++;
                        }
                    });


            hiddenInputs.innerHTML += `<input type="hidden" name="MesaId" value="@Model.MesaId" />`;

            if (!hasItems) {
                summaryItems.innerHTML = '<div class="empty-message">No hay productos seleccionados</div>';
                document.querySelector('.confirm-btn').disabled = true;
            } else {
                document.querySelector('.confirm-btn').disabled = false;
            }

            document.getElementById('totalAmount').textContent = `₡${total.toLocaleString()}`;
        }


        //filtros de los platillos por precio y tipo
        function filtrarMenu() {
            const tipo = document.getElementById('filterTipo').value;
            const precioFiltro = document.getElementById('filterPrecio').value;

            document.querySelectorAll('.menu-item').forEach(item => {
                const tipoItem = item.getAttribute('data-tipo');
                const precio = parseFloat(item.getAttribute('data-price'));
                let mostrar = true;

                if (tipo !== 'todos' && tipoItem !== tipo) mostrar = false;
                if (precioFiltro === 'menor' && precio >= 5000) mostrar = false;
                if (precioFiltro === 'mayor' && precio < 5000) mostrar = false;

                item.style.display = mostrar ? 'block' : 'none';
            });
        }


        document.getElementById('pedidoForm').addEventListener('submit', function (e) {
            e.preventDefault();



            // datos del pedido actualizados e identificados segun un token
            updateOrderSummary();

            fetch(this.action, {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                })
                .catch(error => console.error('Error:', error));
        });



    </script>
</body>
</html>
